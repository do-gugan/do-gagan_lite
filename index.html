<!doctype html>

<html lang="ja">
<head>
  <meta charset="utf-8">

  <title>動画眼Lite</title>
  <style type="text/css">
    body {
        font-size:medium;
        font-family: "Helvetica Neue",Arial,"Hiragino Kaku Gothic ProN","Hiragino Sans",Meiryo,sans-serif;
        background-color: #fff;
    }
    div#flexcontainer {
        max-width:90%;
        background-color: #ddd;
        display: flex;
        flex-flow: row nowrap;
        justify-content: space-around ;
        height:85vh;
    }
    div#playerContainer {
        background-color: #fff;
        flex-basis:70%;
    }
    div#rightBar {
        flex-basis:30%;
    }
    div#search {
        padding:0.2em;
    }
    select#searchMethod {
        width:4em;
    }
    input#searchWord {
        width:16.9em;
    }
    input[type="search"] {
        -webkit-appearance: searchfield;
    }
    input[type="search"]::-webkit-search-cancel-button {
        -webkit-appearance: searchfield-cancel-button;
    }

    input#searchClearButton {
        border:0x;
    }
    div#scripts {
        background-color: #ccc;
        overflow-y: scroll;
        border:1px solid #999;
        height:100%;
    }
    div.row {
        display: flex;
        flex-flow: row nowrap;
        margin:0.1em;
        border:1px solid #888;
    }
    /* 検索にマッチして非表示にする */
    div.row.hidden {
        display: none;
    }
    /* 検索にマッチして強調する */
    div.row.emphasise > div.script {
        background-color: rgb(210, 230, 255);
    }
    
    div.in {
        background-color: #cfc;
        text-align:right;
        align-self:stretch;
        padding: 0.3em;
        flex-shrink: 1;
        flex-basis:30px;
    }
    div.script {
        background-color: #fff;
        flex-grow: 6;
    }

    div#controls {
        display:flex;
        flex-flow: row nowrap;
        justify-content: center;
    }
    div.controlButton{
        border: 1px solid #333;
        background-color: #aaa;
        padding:0.5em;
        text-align: center;
        width:8em;
        vertical-align: middle;
    }
    div.controlButton:hover{
        background-color: #ccc;        
    }
    span.controlButton{
        letter-spacing:-0.45em;
        vertical-align: middle;
        padding-right: 0.3em;
    }
    /* FireFoxで◀◀／▶▶をletter-spacingで字詰めすると欠けるのでアドホック対応*/
    _:lang(x)::-moz-placeholder, span.controlButton {
        letter-spacing:-0.34em;   
    }

    span.shortcut {
        font-size: 70%;
        color:#888;
    }
    div#howto {
        padding-left:3em;
        height:20em;
    }
    footer {
        color:#777;
        text-align:center;
        position:absolute;
        width:100%;
        bottom: 1em;
    }
    img#pause {
        height:12px;
        width:10px;
        margin-top:5px;
        margin-right:6px;
    }
    div.speaker0 {
        background-color: #CCFFCC;
    }
    div.speaker1 {
        background-color: #FFD5EC;
    }
    div.speaker2 {
        background-color: #CCFFCC;
    }
    div.speaker3 {
        background-color: #FFAADD;
    }
    div.speaker4 {
        background-color: #FFFFCC;
    }
    div.speaker5 {
        background-color: #FFDBC9;
    }
    div.speaker6 {
        background-color: #E6FFE9;
    }
    div.speaker7 {
        background-color: #EAD9FF;
    }

    div.current {
        border: 3px solid blue;        
        outline-offset: -14px;
    }

    @media screen and (max-height: 1000px){
        #ahowto {display:none}
    }
  </style>
  <script src="test.json.js" id="scriptsJson"></script>
  <script>
      var updateCurrentInterval = new Array(); //現在位置更新用タイマー
      function initialize(){
        //グローバル変数
        const player = document.getElementById("player"); //動画プレーヤー
        isPlaying = false; //再生中フラグ

        //再生状態チェックイベントハンドラー
        player.addEventListener('playing', (event) => {
            //console.log('Video is played');
            isPlaying = true;
            play();
        });
        player.addEventListener('pause', (event) => {
            //console.log('Video is paused');
            isPlaying = false;
            pause();
        });


        //キーボードショートカットのリスナーをセット
        document.body.addEventListener('keydown',
        event => {
            //alert(event.key);
            if (event.key === 's' && event.altKey) {
                playToggle();
                event.preventDefault();
            } else if (event.key === 'q' && event.altKey) {
                skipBackward();
                event.preventDefault();
            } else if (event.key === 'w' && event.altKey) {
                skipForward();
                event.preventDefault();
            } else {
                //単体キー
                //検索欄にフォーカスがある場合は無視
                activeElement = document.activeElement;
                //console.log(activeElement['id']);
                if (activeElement['id'] != "searchWord"){
                    switch (event.key){
                        case ' ':
                            playToggle();
                            event.preventDefault();
                            break;
                        case 'q':
                            skipBackward();
                            break;
                        case 'w':
                            skipForward();
                            break;
                    }
                }
            }
        });

        //スキップボタン内の秒数プルダウンメニューでonClickイベントを破棄
        document.getElementById('backwardSec').addEventListener('click', e=> {
            e.stopPropagation()}, false
        )
        document.getElementById('forwardSec').addEventListener('click', e=> {
            e.stopPropagation()}, false
        )

        loadJson();
    }

    //JSONデータをもつjsファイルを読み込み、リストに表示する
    function loadJson(){
        const scriptsJsonSTR = JSON.stringify(scriptsJson)
        var scripts = JSON.parse(scriptsJsonSTR);
        scripts.forEach(scriptRecord => {
            row = "<div class='row' id='" + scriptRecord["in"] + "' onClick='jumpToTimeIndex(" + scriptRecord["in"] + ")'><div class='in speaker" + scriptRecord["speaker"] + "'>" + secToMinSec(scriptRecord["in"]) + "</div><div class='script'>" + scriptRecord["script"] + "</div></div>\n";
            document.getElementById("scripts").innerHTML += row;
        });
    }

    //再生制御
    function playToggle(){
        //alert (isPlaying);
        if (isPlaying==true){
            pause();
        } else {
            play();
        }
    }
    function play(){
        //console.log("play");
        player.play();
        document.getElementById('payPause').innerHTML = "▶<span class='shortcut'> (Space)</span>";

        //現在位置更新タイマー開始
        updateCurrentInterval.push(setInterval("updateCurrentMarker();",500)); //0.5秒毎に更新
    }
    function pause(){
        //console.log("pause");
        player.pause();
        document.getElementById('payPause').innerHTML = "<img src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAABCAYAAADn9T9+AAAAHElEQVQImWNkYGD4z4AAjP//I7iMjIwQDgMDAwBzGQUBc+dnkwAAAABJRU5ErkJggg=='' id='pause' alt='II' /><span class='shortcut'> (Space)</span>";

        //現在位置更新タイマー停止
        if (updateCurrentInterval.length > 0) {
            clearInterval(updateCurrentInterval.shift());
        }
    }

    //現在再生位置を強調表示（タイマーで周期的に呼ばれる）
    function updateCurrentMarker(){
        current = scriptsJson.find(script => script['in'] >= player.currentTime + 0.1); //タイムコードが追い越すレコードを取得。少し早めに反映（+0.1）
        current = scriptsJson[scriptsJson.indexOf(current) -1 ]; //そのひとつ手前のレコードを選択

        //フォーカススタイルをリセット
        currents = document.getElementsByClassName(['current']); //currentsオブジェクトにはforEachが使えない
        for (let current of currents) {
            current.classList.remove('current');
        }

        //フォーカススタイルを適用
        if (current != null){
            //console.log("now:" + player.currentTime + " in:" + current['in'] + " script:" +current['script']);
            document.getElementById(current['in']).classList.add("current");

            //リストをスクロール
            document.getElementById(current['in']).scrollIntoView({behavior: "smooth", block: "center"}); //block: nearestも捨てがたい
        }
    }

    function skipForward(){
        var sec = document.getElementById('forwardSec').value;
        jumpToTimeIndex(parseFloat(player.currentTime) + parseFloat(sec));
    }
    function skipBackward(){
        var sec = document.getElementById('backwardSec').value;
        jumpToTimeIndex(parseFloat(player.currentTime) - parseFloat(sec));
    }
    //動画再生位置を指定秒に移動する
    function jumpToTimeIndex(sec){
        document.getElementById('body').focus();
        //alert(sec); 
        player.currentTime = sec;
        play();
    }

    //秒インデックスを「分：秒」形式に変換
    function secToMinSec(secTotal){
        min = Math.floor(secTotal / 60);
        sec = secTotal - min*60;
        return ( '00' + min ).slice( -2 ) + ":" + ( '00' + sec ).slice( -2 )
    }

    //検索機能
    function searchWordChanged() {
        word = document.getElementById('searchWord').value;
        method = document.getElementById('searchMethod').value;
        resetSearch();

        if (word){
            //console.log(word + `(${method})`);
            switch (method){
                case "filter":
                    //wordを含まないものを非表示にする
                    notMatchedScripts = scriptsJson.filter(script => !script['script'].includes(word));
                    notMatchedScripts.forEach(script => document.getElementById(script['in']).classList.add("hidden"));                    
                    break;
                case "emphasise":
                    //wordを含むものを強調する
                    matchedScripts = scriptsJson.filter(script => script['script'].includes(word));
                    matchedScripts.forEach(script => document.getElementById(script['in']).classList.add("emphasise"));                    
                    break;
            }            
        }
        document.getElementById('searchWord').focus();
    }

    //検索によるスタイルをリセットする
    function resetSearch() {
        
        allRow = document.getElementsByClassName(['row']); //currentsオブジェクトにはforEachが使えない
        for (let row of allRow) {
            row.classList.remove('hidden');     //非表示行を復活
            row.classList.remove('emphasise');  //強調行をリセット
        }
    }


  </script>
</head>

<body onLoad="initialize();" id="body">
    <header></header>
    <div id="flexcontainer">
        <!--動画プレーヤー-->
        <div id="playerContainer">
            <video controls width="100%" id="player">
                <source src="test.mp4" type="video/mp4">   
                お使いのブラウザはビデオ再生に対応していません。
            </video>
            <div id="controls">
                <div class="controlButton" id="backword" onclick="skipBackward();">
                    <span class="controlButton">◀◀</span> <span class="shortcut">(Q)</span>
                    <select id="backwardSec">
                        <option value=3>3秒</option>
                        <option value=5>5秒</option>
                        <option value=10>10秒</option>
                        <option value=15 selected>15秒</option>
                        <option value=30>30秒</option>
                        <option value=60>1分</option>
                        <option value=120>2分</option>
                        <option value=180>3分</option>
                        <option value=300>5分</option>
                        <option value=600>10分</option>
                    </select>
                </div>
                <div class="controlButton" id="payPause" onClick="playToggle()"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAABCAYAAADn9T9+AAAAHElEQVQImWNkYGD4z4AAjP//I7iM
                    jIwQDgMDAwBzGQUBc+dnkwAAAABJRU5ErkJggg==" id="pause" alt="II" /> <span class='shortcut'>(Space)</span></div></dib>
                <div class="controlButton" id="forward" onClick="skipForward();">
                    <select id="forwardSec">
                        <option value=3>3秒</option>
                        <option value=5>5秒</option>
                        <option value=10>10秒</option>
                        <option value=15>15秒</option>
                        <option value=30>30秒</option>
                        <option value=60 selected>1分</option>
                        <option value=120>2分</option>
                        <option value=180>3分</option>
                        <option value=300>5分</option>
                        <option value=600>10分</option>
                    </select>
                    <span class="shortcut">(W)</span> <span class="controlButton">▶▶</span>
                </div>
            </div>
            <div id="howto">
                <h1>■使い方</h1>
                <ul>
                    <li>右の発話リストから聞きたい発話をクリックすると当該箇所が再生されます。</li>
                    <li>スペースキーで再生、一時停止切り替え</li>
                    <li>「w」キーで指定秒数進む</li>
                    <li>「q」キーで指定秒数戻る</li>
                    <li>検索欄にフォーカスがある場合は上記ショートカットは無効。代わりに、Alt+s,w,qが常時有効。</li>
                    <li>移動する秒数はプルダウンメニューで指定</li>
                    <li>語句検索は右上の検索ボックスに単語を入力します。
                        <ul>
                            <li>抽出：指定語を含む行のみに絞り込み表示します。</li>
                            <li>強調：指定語を含む行に色をつけ目立たせます。</li>
                            <li>現状、複数の単語によるAND/OR検索はできません。</li>
                            <li>現状、大文字小文字、半角全角は区別されます。</li>
                        </ul>
                    </li>
                    <li>動作確認ブラウザ：Microsoft Edge（Chromium版）またはGoogle Chrome</li>
                </ul>
            </div>        
        </div>
        <!--発話一覧-->
        <div id="rightBar">
            <div id="search">
                <select id="searchMethod" onChange="searchWordChanged();" >
                    <option value="filter">抽出</option>
                    <option value="emphasise">強調</option>
                </select>
                <input type="search" id="searchWord" placeholder="検索語を入力" onInput="searchWordChanged();" onSearch="resetSearch();" />
                <!--input type="button" id="searchClearButton" onClick="searchWordClear();" value="×" /-->
            </div>
            <div id="scripts">
            </div>   
        </div>
    </div>

<footer>動画眼Lite by do-gugan.com</footer>
</body>
</html>
